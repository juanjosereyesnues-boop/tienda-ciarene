<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ciarené - Tienda</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --pink: #ff4d6d; --dark: #2d3436; }
        body { font-family: 'Poppins'; margin: 0; background: #f9f9f9; }
        .header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px; }
        .card { background: white; border-radius: 20px; overflow: hidden; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 300px; object-fit: cover; }
        .card-info { padding: 15px; text-align: center; }
        
        /* MODAL */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 5% auto; width: 90%; max-width: 400px; border-radius: 25px; overflow: hidden; position: relative; }
        .modal-body { padding: 20px; }
        select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 10px; }
        .btn-buy { width: 100%; padding: 15px; background: var(--pink); color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="color:var(--pink)">Ciarené</h2>
        <div>
            <span id="user-display" style="margin-right:15px; font-size: 0.8rem;"></span>
            <a href="carrito.html" style="color:var(--dark); text-decoration:none"><i class="fas fa-shopping-bag"></i> <span id="count">0</span></a>
        </div>
    </div>

    <div class="grid" id="productos"></div>

    <div id="modal-producto" class="modal">
        <div class="modal-content">
            <img id="m-img" style="width:100%; height:250px; object-fit:cover">
            <div class="modal-body">
                <h2 id="m-nom" style="margin:0"></h2>
                <p id="m-desc" style="color:#666; font-size:0.9rem"></p>
                <h3 id="m-pre" style="color:var(--pink)"></h3>
                <label>Talla:</label> <select id="m-talla"></select>
                <label>Color:</label> <select id="m-color"></select>
                <button class="btn-buy" onclick="añadir()">Añadir al Carrito</button>
                <button onclick="cerrar()" style="background:none; border:none; width:100%; margin-top:10px; color:#aaa; cursor:pointer">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // SEGURIDAD
        const user = localStorage.getItem('usuario_ciarene');
        if(!user) window.location.href = "/";
        document.getElementById('user-display').innerText = `Hola, ${user.split('@')[0]}`;

        let carrito = JSON.parse(localStorage.getItem('carrito_ciarene')) || [];
        let pSel = null;

        async function cargar() {
            const res = await fetch('/api/productos');
            const json = await res.json();
            const cont = document.getElementById('productos');
            json.data.forEach(p => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => abrir(p);
                div.innerHTML = `<img src="${p.imagen}"><div class="card-info"><h3>${p.nombre}</h3><b style="color:var(--pink)">$${p.precio.toLocaleString()}</b></div>`;
                cont.appendChild(div);
            });
            actualizar();
        }

        function abrir(p) {
            pSel = p;
            document.getElementById('m-img').src = p.imagen;
            document.getElementById('m-nom').innerText = p.nombre;
            document.getElementById('m-desc').innerText = p.descripcion;
            document.getElementById('m-pre').innerText = `$${p.precio.toLocaleString()}`;
            document.getElementById('m-talla').innerHTML = p.tallas.map(t=>`<option>${t}</option>`).join('');
            document.getElementById('m-color').innerHTML = p.colores.map(c=>`<option>${c}</option>`).join('');
            document.getElementById('modal-producto').style.display = 'block';
        }

        function cerrar() { document.getElementById('modal-producto').style.display = 'none'; }

        function añadir() {
            const t = document.getElementById('m-talla').value;
            const c = document.getElementById('m-color').value;
            carrito.push({ nombre: `${pSel.nombre} (Talla: ${t}, Color: ${c})`, precio: pSel.precio });
            localStorage.setItem('carrito_ciarene', JSON.stringify(carrito));
            actualizar();
            cerrar();
        }

        function actualizar() { document.getElementById('count').innerText = carrito.length; }
        window.onload = cargar;
    </script>
</body>
</html>
